<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Inventario</ion-title>
  </ion-toolbar>
</ion-header>


<ion-content class="ion-padding">
  <!-- Formulario de agregar/editar solo visible si no es trabajador -->
  <form *ngIf="userRole === 'admin' || userRole === 'gestor'" [formGroup]="form" (ngSubmit)="save()">
    <ion-item>
      <ion-label position="floating">Descripción</ion-label>
      <ion-input formControlName="description"></ion-input>
    </ion-item>
    <ion-item>
      <ion-label position="floating">N° Serie</ion-label>
      <ion-input formControlName="serialNumber"></ion-input>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Ubicación</ion-label>
      <ion-input formControlName="location"></ion-input>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Stock</ion-label>
      <ion-input type="number" formControlName="stock"></ion-input>
    </ion-item>
    <ion-item>
      <ion-label position="floating">Stock Mínimo</ion-label>
      <ion-input type="number" formControlName="minStock"></ion-input>
    </ion-item>
    <ion-button expand="block" type="submit" [disabled]="loading || form.invalid">
      <ion-spinner *ngIf="loading" name="crescent"></ion-spinner>
      <span *ngIf="!loading">{{ editingId ? 'Actualizar' : 'Agregar' }}</span>
    </ion-button>
    <ion-button expand="block" fill="clear" color="medium" type="button" (click)="cancel()" *ngIf="editingId">Cancelar</ion-button>
  </form>

  <!-- Separador visual -->
  <div style="margin: 32px 0 24px 0; border-bottom: 2px solid #e0e0e0;"></div>

  <!-- Buscador -->
  <ion-item>
    <ion-label position="floating">Buscar por nombre</ion-label>
    <ion-input [(ngModel)]="filterText" name="filterText"></ion-input>
  </ion-item>

  <!-- Tabla visual tipo dashboard -->
  <div class="inventario-table-wrapper" style="overflow-x:auto; margin-top: 16px;">
    <table class="inventario-table" style="width:100%; border-collapse:collapse; background:#fff;">
      <thead>
        <tr style="background:#374151; color:#fff;">
          <th style="padding:10px 8px;">Código</th>
          <!-- <th style="padding:10px 8px;">Componente/Pieza</th> -->
          <th style="padding:10px 8px;">Descripción</th>
          <th style="padding:10px 8px;">Stock Actual</th>
          <th style="padding:10px 8px;">Stock Mínimo</th>
          <th style="padding:10px 8px;">Ubicación</th>
          <th style="padding:10px 8px;">Estado</th>
          <th style="padding:10px 8px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredItems" style="border-bottom:1px solid #e0e0e0;">
          <td style="padding:8px 6px; font-weight:600;">{{ item.serialNumber }}</td>
          <!-- <td style="padding:8px 6px;">{{ item.component || '-' }}</td> -->
          <td style="padding:8px 6px;">{{ item.description }}</td>
          <td style="padding:8px 6px; text-align:center;">{{ item.stock }}</td>
          <td style="padding:8px 6px; text-align:center;">{{ item.minStock }}</td>
          <td style="padding:8px 6px;">{{ item.location }}</td>
          <td style="padding:8px 6px; text-align:center;">
            <span
              class="inventario-estado"
              [ngClass]="{
                'estado-alto': (item.stock / item.minStock) >= 2,
                'estado-medio': (item.stock / item.minStock) > 0.8 && (item.stock / item.minStock) < 2,
                'estado-critico': (item.stock / item.minStock) <= 0.8
              }"
            >
              {{
                (item.stock / item.minStock) <= 0.8 ? 'CRÍTICO' :
                ((item.stock / item.minStock) >= 2 ? 'ALTO' : 'MEDIO')
              }}
              <span style="font-size:11px; margin-left:6px;">
                ({{ ((item.stock / item.minStock) * 100) | number:'1.0-0' }}%)
              </span>
            </span>
          </td>
          <td style="padding:8px 6px; text-align:center;">
            <ng-container *ngIf="userRole === 'admin' || userRole === 'gestor'; else soloVer">
              <ion-button fill="clear" color="primary" size="small" (click)="edit(item)">
                <ion-icon name="create-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" color="danger" size="small" (click)="delete(item)">
                <ion-icon name="trash-outline"></ion-icon>
              </ion-button>
            </ng-container>
            <ng-template #soloVer></ng-template>
            <ion-button fill="clear" color="medium" size="small" (click)="toggleMovimientos(item)">
              <ion-icon [name]="expandedItemId === item.id ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
            </ion-button>
          </td>
        </tr>
        <ng-container *ngFor="let item of filteredItems">
          <tr *ngIf="expandedItemId === item.id" expanded>
            <td colspan="7">
              <div>
                <h3 style="margin:0 0 8px 0; font-size:16px; color:var(--ion-color-primary, #374151);">Historial de movimientos</h3>
                <form [formGroup]="filterMovsForm" (ngSubmit)="$event.preventDefault()" style="display:flex; gap:16px; align-items:center; margin-bottom:8px;">
                  <ion-item style="flex:1;">
                    <ion-label>Desde: </ion-label>
                    <ion-input type="date" formControlName="start" (ionChange)="onMovsFilterChange(item)"></ion-input>
                  </ion-item>
                  <ion-item style="flex:1;">
                    <ion-label>Hasta: </ion-label>
                    <ion-input type="date" formControlName="end" (ionChange)="onMovsFilterChange(item)"></ion-input>
                  </ion-item>
                </form>
                <ng-container *ngIf="movimientosPorItem[item.id] && movimientosPorItem[item.id].length; else noMovs">
                  <ul style="margin:0; padding-left:18px;">
                    <li *ngFor="let mov of movimientosPorItem[item.id]">
                      <strong>{{ mov.type | titlecase }}</strong> - {{ mov.quantity }}
                      <span style="color:var(--ion-color-medium, #888); font-size:12px;">({{ mov.date | date:'dd/MM/yyyy HH:mm' }})</span>
                    </li>
                  </ul>
                </ng-container>
                <ng-template #noMovs>
                  <p style="color:var(--ion-color-medium, #888); margin:0;">Sin movimientos registrados.</p>
                </ng-template>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</ion-content>
